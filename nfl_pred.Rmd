---
title: "NFL predictions"
output: html_notebook
---

# Purpose

The purpose of this project is to predict the winners of a Week of NFL games based on pre-season rankings and scores during the regular season.

The first model to be used is very simple - I use the preseason rankings as prior information, and assign an ability score based on those rankings. Then I use the point spread as data to create a posterior distribution of ability. Finally, I calculate the probability of winning based on the matchup and posterior ability scores.

# Set up

```{r setup}
library(tidyverse)
library(rvest)
library(forcats)
library(stringr)
library(rstan)
library(arm)
```

The parameters are as follows

```{r}
this_week <- 3
```


# Obtaining data

## Preseason rankings

We try to get preseason ranking from [Yahoo](https://sports.yahoo.com/nfl-preseason-power-rankings-2017-133009081.html). It's a slightly annoying webscraping exercise - on this website the preseason ranks are listed in HTML `h2` headlines, along with other headlines. I used the nifty SelectorGadget that came with the `rvest` package to make this discovery, rather than the developer tools in Microsoft Edge, which are powerful but rather arcane.

```{r}
preseas_html <- read_html("https://sports.yahoo.com/nfl-preseason-power-rankings-2017-133009081.html")

preseas_html %>% 
  html_nodes(xpath="//h2") %>% 
  html_text() %>%
  data_frame(rank_text = .)  %>% 
  filter(str_detect(rank_text,"^\\d+")) %>% 
  mutate(rank = str_extract(rank_text,"^\\d+"),
         team = str_extract(rank_text,"[A-Za-z].+$")) %>% 
  dplyr::select(-rank_text) -> preseason_ranks

preseason_ranks
```

## Scores

Now I get scores. To do this I scrape the [Pro Football Reference](https://www.pro-football-reference.com/years/2017/week_1.htm) site because they seem like they have the easiest layout to scrape and a logical URL structure. I'm also testing out my functional programming skills here. One of the most annoying ugly things about programming has been accumulating data and combining it. The `foreach` package made that more elegant, but `purrr` should make that even better.

```{r}
url_scrape <- function(week,year=2017) {
  paste0("https://www.pro-football-reference.com/years/",year,"/week_",week,".htm")
}


read_nfl_score <- function(week,year=2017) {
  week_html <- read_html(url_scrape(week,year=year))
  week_html %>% 
    html_nodes(".teams") %>% 
    html_text %>% 
    data_frame(score_text=.) %>% 
    mutate(score_text = str_replace_all(score_text,"[\\n\\t]+",","),
           score_text = str_replace(score_text,"\\w+ \\d{1,2}, \\d{4}","")) %>% 
    tidyr::extract(score_text,c("visiting_team","visiting_score","home_team","home_score"),
                   "([\\w ]*),([\\d]+)\\s*,.*,([\\w ]*),([\\d]+)\\s*,")
}

data_frame(week = 1:(this_week-1)) %>% 
  mutate(week_scores = purrr::map(week,~read_nfl_score(.x))) %>%
  unnest() -> nfl_scores

nfl_scores
 
```

## Schedule

We download the schedule in a similar fashion to the scores. Issue is, the tables are the same, but they use tabs and newlines which makes it a little trickier. Note this uses the same `url_scrape` function as above.

```{r}
read_nfl_schedule <- function(week,year=2017) {
  week_html <- read_html(url_scrape(week,year=year))
  week_html %>% 
    html_nodes(".teams") %>% 
    html_text %>% 
    data_frame(score_text=.) %>% 
    mutate(score_text = str_replace_all(score_text,"[\\n\\t]+",","),
           score_text = str_replace(score_text,"\\w+ \\d{1,2}, \\d{4}|Sunday|Saturday|Monday|Thursday","")) %>% 
    filter(str_detect(score_text,"Preview")) %>% 
    tidyr::extract(score_text,c("visiting_team","home_team"),
                   "([\\w ]*),.*,([\\w ]*),")
}

upcoming_games <- read_nfl_schedule(this_week)
upcoming_games %>% 
  bind_rows(data_frame(home_team="Los Angeles Rams",visiting_team="San Francisco 49ers")) -> upcoming_games
```


# Modeling

The model here is listed at [Andy Gelman's talk](https://youtu.be/T1gYvX5c2sM?t=7m14s). It is included in the `nfl_model.stan` file. The `R` code is listed [a little later in the same talk](https://youtu.be/T1gYvX5c2sM?t=8m56s), and is included below, modified to fit my problem.


```{r}
rstan_options(auto_write=TRUE)
options(mc.cores = parallel::detectCores())

teams <- as_vector(preseason_ranks %>% dplyr::select(team))
nteams <- length(teams)
prior_score <- rev(1:nteams)
prior_score <- (prior_score-mean(prior_score)) / (2*sd(prior_score))

ngames <- nrow(nfl_scores)

team1 <- match(as_vector(nfl_scores %>% dplyr::select(home_team)),teams)
score1 <- as.numeric(as_vector(nfl_scores %>% dplyr::select(home_score)))
team2 <- match(as_vector(nfl_scores %>% dplyr::select(visiting_team)),teams)
score2 <- as.numeric(as_vector(nfl_scores %>% dplyr::select(visiting_score)))

df <- 7

# for predictive probabilities
newgames <- nrow(upcoming_games)
newteam1 <- match(upcoming_games$home_team,teams)
newteam2 <- match(upcoming_games$visiting_team,teams)


data <- c("nteams","ngames","team1","score1","team2","score2","prior_score","df","newgames","newteam1","newteam2")
fit <- stan("nfl_model_with_pred.stan",data=data,iter=3000,warmup=1250,control=list(adapt_delta=0.95))

fit
```

## Team quality

We graph here the posterior distribution of the quality factors. 

```{r}
sims <- rstan::extract(fit)

colVars <- function(a) {n <- dim(a)[[1]]; c <- dim(a)[[2]]; return(.colMeans(((a - matrix(.colMeans(a, n, c), nrow = n, ncol = c, byrow = TRUE)) ^ 2), n, c) * n / (n - 1))}

a_sims <- sims$a
a_hat <- colMeans(a_sims)
a_se <- sqrt(colVars(a_sims))

data_frame(teams=factor(rev(teams),ordered=TRUE),quality_mean=rev(a_hat),quality_se=rev(a_se),
           preseason_rank = 32:1) -> post

post %>% 
  ggplot(aes(x=reorder(teams,rev(preseason_rank)))) + 
  scale_x_discrete() +
  geom_segment(aes(xend=teams,y=quality_mean-quality_se,yend=quality_mean+quality_se)) + 
  geom_point(aes(y=quality_mean)) +
  coord_flip() +
  labs(x = "",y="",title=paste0("Posterior distribution of team quality after Week",this_week-1),
       subtitle="Ordered by preseason rank")

```

## Predictions

Do predictions in Stan using a `generated quantities` block, and bring over to R. 

```{r}
pred_chains <-  extract(fit,"new_dif")$new_dif
pred_diffs <- colMeans(pred_chains>0)
pred_spread <- colMeans(pred_chains)
upcoming_games %>% 
  bind_cols(data_frame(pred_home_win=pred_diffs,pred_spread=pred_spread)) %>% 
  dplyr::select(home_team,visiting_team,pred_home_win,pred_spread) -> upcoming_game_win
upcoming_game_win %>% 
  mutate(pred_home_win = sprintf("%3.1f%%",pred_home_win*100),
         pred_spread = sprintf("%5.2f",pred_spread))
```

# Home field advantage

I wrote an extension `nfl_model_pred_homeadv.stan` that basically adds a home field advantage, a $t_3$ distribution centered at 0 and sigma of 1, to all differences. It doesn't require further data, but it will be interesting to look at it.

```{r}
fit2 <- stan("nfl_model_pred_homeadv.stan",data=data,iter=6000,warmup=2000,control=list(adapt_delta=0.97))

fit2
```

## Team quality considering home field

```{r}
sims2 <- rstan::extract(fit2)

a_sims2 <- sims2$a
a_hat2 <- colMeans(a_sims2)
a_se2 <- sqrt(colVars(a_sims2))

data_frame(teams=factor(rev(teams),ordered=TRUE),quality_mean=rev(a_hat2),quality_se=rev(a_se2),
           preseason_rank = 32:1) -> post2

post2 %>% 
  ggplot(aes(x=reorder(teams,rev(preseason_rank)))) + 
  scale_x_discrete() +
  geom_segment(aes(xend=teams,y=quality_mean-quality_se,yend=quality_mean+quality_se)) + 
  geom_point(aes(y=quality_mean)) +
  coord_flip() +
  labs(x = "",y="",title=paste0("Posterior distribution of team quality after Week",this_week-1),
       subtitle="Ordered by preseason rank, home field advantage included")

post2 %>% 
  ggplot(aes(x=fct_reorder(teams,quality_mean))) + 
  scale_x_discrete() +
  geom_segment(aes(xend=teams,y=quality_mean-quality_se,
                   yend=quality_mean+quality_se)) + 
  geom_point(aes(y=quality_mean)) +
  coord_flip() +
  labs(x = "",y="",title=paste0("Posterior distribution of team quality after Week",this_week-1),
       subtitle="Ordered by current quality, home field advantage included")

```

## What is the homefield advantage?

The homefield advantage can be explored by extracting the `home_adv` parameter and investigating its density.

```{r}
home_adv <- rstan::extract(fit2,"home_adv")

data_frame(home_adv=home_adv$home_adv) -> home_adv_df
home_adv_df %>% 
  ggplot(aes(x=home_adv)) +
  geom_density()

home_adv_df %>% 
  summarize(n=n(),home_adv_mean = sprintf("%4.2f",mean(home_adv)),home_adv_sd=sprintf("%5.3f",sd(home_adv)))
```

We expect home field advantage to be positive. A team playing at home can expect to add `home_adv` points to the spread vs. the visiting team. However, at the beginning of the season there may not be enough data to get a sensible `home_adv` estimate, and it will probably stay close to 0 a few weeks into the season.

## Who's gonna win under home field advantage

```{r}
pred_chains2 <-  extract(fit2,"new_dif")$new_dif
pred_diffs2 <- colMeans(pred_chains2>0)
pred_spread2 <- colMeans(pred_chains2)
upcoming_games %>% 
  bind_cols(data_frame(pred_home_win=pred_diffs2,pred_spread=pred_spread2)) %>% 
  dplyr::select(home_team,visiting_team,pred_home_win,pred_spread) -> upcoming_game_win
upcoming_game_win %>% 
  mutate(pred_home_win = sprintf("%3.1f%%",pred_home_win*100),
         pred_spread = sprintf("%5.2f",pred_spread))
```

# Injuries

This extends the model to include injuries in addition to home field advantage.

## Obtaining injury data

First, we get injuries by week. Fox Sports seems to have the most usable data on this (i.e. easiest to scrape), so use their site. Then we use everybody listed as Doubtful or Out as a proxy for the severity of injuries to a team.

```{r}
inj_url <- function(week,year=2017) {
  #paste0("http://www.nfl.com/injuries?week=",week)
  paste0("http://www.foxsports.com/nfl/injuries?season=",year,"&seasonType=1&week=",week)
}

injury_table <- function(week,year=2017) {
  inj_html <- read_html(inj_url(week))
  
  # team names
  inj_html %>% 
    html_nodes(".wisbb_teamCity") %>% 
    html_text -> team_city
  
  inj_html %>% 
    html_nodes(".wisbb_teamName") %>% 
    html_text -> team_name
  
  paste(team_city,team_name) -> team_full_name
  
  # number of injured players
  inj_html %>% 
    html_nodes(".wisbb_injuryTable") %>% 
    html_table(fill=TRUE) -> inj_tables
  
  data_frame(team_name=team_full_name,data=inj_tables) %>% 
    unnest() %>% 
    rename(game_status=`Game Status`) %>% 
    dplyr::select(-starts_with("V"))
  
}

data_frame(week=1:this_week) %>% 
  mutate(data = map(week,injury_table)) %>% 
  unnest() -> injury_table_so_far

injury_table_so_far %>% 
  group_by(week,team_name) %>% 
  summarize(injuries=sum(game_status %in% c("Doubtful","Out"))) -> injury_numbers

injury_numbers
```

Now we merge injury numbers by the NFL scores we obtained earlier.

```{r}
nfl_scores %>% 
  left_join(injury_numbers,by=c("week"="week","visiting_team"="team_name")) %>% 
  rename(visiting_injuries=injuries) %>% 
  left_join(injury_numbers,by=c("week"="week","home_team"="team_name")) %>% 
  rename(home_injuries=injuries) -> nfl_scores_injuries
nfl_scores_injuries
```

Next, we need to add the injuries to upcoming games.

```{r}
injury_numbers %>% 
  filter(week==this_week) %>% 
  ungroup() %>% 
  dplyr::select(-week) -> injury_num_this_week

upcoming_games %>% 
  left_join(injury_num_this_week ,by=c("visiting_team"="team_name")) %>% 
  rename(visiting_injuries=injuries) %>% 
  left_join(injury_num_this_week,by=c("home_team"="team_name")) %>% 
  rename(home_injuries=injuries) -> upcoming_games_injuries
upcoming_games_injuries
```

## Modeling

Now we're ready to fit the model in `Stan`. Home field advantage has a prior of normal with 0 mean and standard deviation of 3. Injury has a prior of normal with 0 mean and standard deviation of 1.

```{r}
teams <- as_vector(preseason_ranks %>% dplyr::select(team))
nteams <- length(teams)
prior_score <- rev(1:nteams)
prior_score <- (prior_score-mean(prior_score)) / (2*sd(prior_score))

ngames <- nrow(nfl_scores_injuries)

team1 <- match(as_vector(nfl_scores_injuries %>% dplyr::select(home_team)),teams)
score1 <- as.numeric(as_vector(nfl_scores_injuries %>% dplyr::select(home_score)))
injury1 <- as.numeric(as_vector(nfl_scores_injuries %>% dplyr::select(home_injuries)))
team2 <- match(as_vector(nfl_scores_injuries %>% dplyr::select(visiting_team)),teams)
score2 <- as.numeric(as_vector(nfl_scores_injuries %>% dplyr::select(visiting_score)))
injury2 <- as.numeric(as_vector(nfl_scores_injuries %>% dplyr::select(visiting_injuries)))

df <- 7

# for predictive probabilities
newgames <- nrow(upcoming_games_injuries)
newteam1 <- match(upcoming_games_injuries$home_team,teams)
newteam2 <- match(upcoming_games_injuries$visiting_team,teams)
newinjury1 <- as.numeric(as_vector(upcoming_games_injuries %>% dplyr::select(home_injuries)))
newinjury2 <- as.numeric(as_vector(upcoming_games_injuries %>% dplyr::select(visiting_injuries)))

# sigmas for prior probabilities
home_sigma <- 3
inj_sigma <- 1


data <- c("nteams","ngames","team1","score1","team2","score2","prior_score","df",
          "injury1","injury2","newgames","newteam1","newteam2","newinjury1","newinjury2",
          "home_sigma","inj_sigma")
fit3 <- stan("nfl_homefield_inj.stan",data=data,iter=5000,warmup=2000,control=list(adapt_delta=0.97))

fit3
```

## Team quality considering home field and injuries

```{r}
sims3 <- rstan::extract(fit3)

a_sims3 <- sims3$a
a_hat3 <- colMeans(a_sims3)
a_se3 <- sqrt(colVars(a_sims3))

data_frame(teams=factor(rev(teams),ordered=TRUE),quality_mean=rev(a_hat3),quality_se=rev(a_se3),
           preseason_rank = 32:1) -> post3

post3 %>% 
  ggplot(aes(x=reorder(teams,rev(preseason_rank)))) + 
  scale_x_discrete() +
  geom_segment(aes(xend=teams,y=quality_mean-quality_se,yend=quality_mean+quality_se)) + 
  geom_point(aes(y=quality_mean)) +
  coord_flip() +
  labs(x = "",y="",title=paste0("Posterior distribution of team quality after Week",this_week-1),
       subtitle="Ordered by preseason rank, home field advantage and injuries included")

post3 %>% 
  ggplot(aes(x=fct_reorder(teams,quality_mean))) + 
  scale_x_discrete() +
  geom_segment(aes(xend=teams,y=quality_mean-quality_se,
                   yend=quality_mean+quality_se)) + 
  geom_point(aes(y=quality_mean)) +
  coord_flip() +
  labs(x = "",y="",title=paste0("Posterior distribution of team quality after Week",this_week-1),
       subtitle="Ordered by current quality, home field advantage and injuries included")

```

## What is the home field advantage in model with injuries

```{r}
home_adv3 <- rstan::extract(fit3,"home_adv")

data_frame(home_adv=home_adv3$home_adv) -> home_adv_df3
home_adv_df3 %>% 
  ggplot(aes(x=home_adv)) +
  geom_density()

home_adv_df3 %>% 
  summarize(n=n(),home_adv_mean = sprintf("%4.2f",mean(home_adv)),home_adv_sd=sprintf("%5.3f",sd(home_adv)))
```

As it will take a few weeks for the model to become stable, we expect home field advantage estimates to be around 0, especially with the injury parameter added. It's possible that the model doesn't quite yet know how to assign "blame" to home field advantage vs. injuries. Eventually, we expect it to be positive.

## What is the injury advantage

```{r}
inj_adv3 <- rstan::extract(fit3,"inj_adv")

data_frame(inj_adv=inj_adv3$inj_adv) -> inj_adv_df3
inj_adv_df3 %>% 
  ggplot(aes(x=inj_adv)) +
  geom_density()

inj_adv_df3 %>% 
  summarize(n=n(),inj_adv_mean = sprintf("%4.2f",mean(inj_adv)),inj_adv_sd=sprintf("%5.3f",sd(inj_adv))) -> inj_adv_summary
inj_adv_summary

inj_adv_mean <- mean(inj_adv_df3$inj_adv)
```

We expect injury advantage to be negative. In the model, this factor is multiplied by the difference in injured players between the home team and visiting team and added to the mean point spread of the distribution. So for every player injured on the home team more than the visiting team, we can expect the home team to have a spread of `inj_adv` fewer points (or lose by `inj_adv` more points).

## Who's gonna win?

```{r}
pred_chains <-  extract(fit3,"new_dif")$new_dif
pred_diffs <- colMeans(pred_chains>0)
pred_spread <- colMeans(pred_chains)
upcoming_games %>% 
  bind_cols(data_frame(pred_home_win=pred_diffs,pred_spread=pred_spread)) %>% 
  dplyr::select(home_team,visiting_team,pred_home_win,pred_spread) -> upcoming_game_win
upcoming_game_win %>% 
  mutate(pred_home_win = sprintf("%3.1f%%",pred_home_win*100),
         pred_spread = sprintf("%5.2f",pred_spread))
```

# References

This was inspired by the soccer example from [Andy Gelman's Stan talk](https://www.youtube.com/watch?v=T1gYvX5c2sM&t=3310s). Code is [here](http://andrewgelman.com/2014/07/13/stan-analyzes-world-cup-data/).
